# 中间驱动面板

<cite>
**本文档引用的文件**   
- [GUIkhQuant.py](file://GUIkhQuant.py)
- [khFrame.py](file://khFrame.py)
- [SettingsDialog.py](file://SettingsDialog.py)
- [README.md](file://README.md)
</cite>

## 目录
1. [简介](#简介)
2. [触发方式设置](#触发方式设置)
3. [账户信息展示](#账户信息展示)
4. [盘前盘后配置](#盘前盘后配置)
5. [核心功能实现](#核心功能实现)

## 简介
中间驱动面板是量化交易系统的核心控制区域，集成了触发方式设置、账户信息展示和盘前盘后配置三大核心功能。该面板通过直观的用户界面，使用户能够灵活配置策略的触发机制、监控虚拟账户状态，并设置盘前盘后的特殊回调时间。面板的设计旨在提供一个高效、易用的策略配置环境，支持从简单的Tick触发到复杂的自定义定时触发等多种策略执行模式。

## 触发方式设置
触发方式设置组允许用户选择策略的执行时机，支持五种不同的触发类型：Tick触发、1分钟K线触发、5分钟K线触发、日K线触发和自定义定时触发。当用户选择不同的触发类型时，界面会动态切换相应的配置选项，以提供最相关的设置。

### 触发类型选择与动态切换
`TriggerConfigGroup` 通过 `QComboBox` 控件实现触发类型的切换。当用户在下拉菜单中选择不同的触发类型时，系统会触发 `currentIndexChanged` 信号，调用 `on_trigger_type_changed` 方法。该方法根据当前选择的索引，更新 `QStackedWidget` 中显示的页面，从而实现界面元素的动态切换。

例如，当选择"自定义定时触发"时，界面会显示一个包含 `QTextEdit` 的页面，允许用户输入多个时间点；而选择"1分钟K线触发"时，则会显示一个提示信息，说明无需额外配置。

**Section sources**
- [GUIkhQuant.py](file://GUIkhQuant.py#L1666-L1668)
- [GUIkhQuant.py](file://GUIkhQuant.py#L3611-L3625)

## 账户信息展示
账户信息展示组提供了虚拟账户的全面视图，包括初始资金、最小交易量等设置项，以及实时的现金、市值和总资产等状态信息。

### 虚拟账户配置
`AccountInfoGroup` 允许用户配置虚拟账户的初始参数。用户可以设置初始资金和最小交易量，这些设置将用于回测和模拟交易。初始资金通过 `QLineEdit` 控件输入，并使用 `QDoubleValidator` 确保输入的是有效的浮点数；最小交易量则使用 `QIntValidator` 确保输入的是整数。

### 实时账户状态
在策略运行过程中，系统会实时更新账户的现金、市值和总资产。这些信息来源于 `context['__account__']` 字典，其中：
- `cash` 表示当前可用于交易的现金
- `market_value` 表示所有持仓按当前市价计算的总市值
- `total_asset` 表示总资产，即现金与市值之和

这些值会定期更新并显示在对应的 `QLabel` 中，为用户提供实时的资金状况。

**Section sources**
- [GUIkhQuant.py](file://GUIkhQuant.py#L1814-L1825)
- [README.md](file://README.md#L1780-L1817)

## 盘前盘后配置
`PrePostMarketGroup` 提供了对盘前和盘后回调的配置功能，允许用户指定在交易时段之外执行特定策略逻辑的时间点。

### 盘前盘后回调机制
用户可以通过复选框启用或禁用盘前和盘后回调，并通过 `QTimeEdit` 控件设置具体的执行时间。默认情况下，盘前回调设置在08:30:00，盘后回调设置在15:30:00。

在策略执行过程中，系统会在每个交易日的指定时间点检查是否启用了相应的回调功能。如果启用了盘前回调且策略实现了 `khPreMarket` 方法，系统将在盘前时间点执行该方法；同样，如果启用了盘后回调且策略实现了 `khPostMarket` 方法，系统将在盘后时间点执行该方法。

这种机制允许用户在非交易时段执行数据准备、风险评估或策略调整等操作，为下一个交易日做好准备。

**Section sources**
- [GUIkhQuant.py](file://GUIkhQuant.py#L1837-L1856)
- [khFrame.py](file://khFrame.py#L1749-L1764)

## 核心功能实现
中间驱动面板的核心功能通过一系列精心设计的方法和类实现，确保了用户界面与底层逻辑的无缝集成。

### on_trigger_type_changed 方法实现
`on_trigger_type_changed` 方法是触发方式动态切换的核心。当用户选择不同的触发类型时，该方法会被调用，根据选择的索引更新界面显示。

```python
def on_trigger_type_changed(self, index):
    """触发类型改变时的处理"""
    self.trigger_stack.setCurrentIndex(index)
    # 根据触发类型启用或禁用相关控件
    if index == 4:  # 自定义定时触发
        self.custom_times_edit.setEnabled(True)
        self.generator_type_combo.setEnabled(True)
    else:
        self.custom_times_edit.setEnabled(False)
        self.generator_type_combo.setEnabled(False)
```

该方法不仅切换了 `QStackedWidget` 的当前页面，还根据触发类型启用了相应的控件，确保用户界面的逻辑一致性。

### generate_time_points 方法实现
`generate_time_points` 方法实现了时间点的智能生成。用户可以通过设置开始时间、结束时间和间隔，自动生成一系列符合要求的时间点。

```python
def generate_time_points(self):
    """生成符合条件的时间点列表"""
    start_seconds = self.start_time_edit.time().hour() * 3600 + self.start_time_edit.time().minute() * 60 + self.start_time_edit.time().second()
    end_seconds = self.end_time_edit.time().hour() * 3600 + self.end_time_edit.time().minute() * 60 + self.end_time_edit.time().second()
    
    interval = self.interval_spin.value()
    current_seconds = start_seconds
    time_points = []
    
    while current_seconds <= end_seconds:
        if self.is_in_trading_hours(current_seconds):
            hours = current_seconds // 3600
            minutes = (current_seconds % 3600) // 60
            seconds = current_seconds % 60
            time_points.append(f"{hours:02d}:{minutes:02d}:{seconds:02d}")
        current_seconds += interval
    
    self.custom_times_edit.setText("\n".join(time_points))
```

该方法还包含了对交易时段的检查，确保生成的时间点都在有效的交易时间内，避免了无效的触发。

**Section sources**
- [GUIkhQuant.py](file://GUIkhQuant.py#L3651-L3737)
- [GUIkhQuant.py](file://GUIkhQuant.py#L3611-L3625)