# 左侧配置面板

<cite>
**本文档引用的文件**
- [GUIkhQuant.py](file://GUIkhQuant.py)
- [khFrame.py](file://khFrame.py)
- [khConfig.py](file://khConfig.py)
- [modules/GUIkhQuant.md](file://modules/GUIkhQuant.md)
</cite>

## 目录
1. [引言](#引言)
2. [策略配置组](#策略配置组)
3. [回测参数配置组](#回测参数配置组)
4. [数据设置组](#数据设置组)
5. [股票池管理组](#股票池管理组)
6. [配置文件结构](#配置文件结构)
7. [结论](#结论)

## 引言
左侧配置面板是看海量化回测系统的核心控制中心，为用户提供策略配置、回测参数、数据设置和股票池管理四大功能组。该面板通过直观的图形界面，将复杂的量化交易配置转化为用户友好的操作流程。本文档基于`modules/GUIkhQuant.md`技术文档，详细解析`StrategyConfigGroup`、`BacktestConfigGroup`、`DataConfigGroup`和`StockPoolGroup`四个核心组件的实现机制，阐述其如何协同工作，将用户输入转化为可持久化的`.kh`配置文件。

**Section sources**
- [modules/GUIkhQuant.md](file://modules/GUIkhQuant.md#L1-L792)

## 策略配置组
策略配置组（`StrategyConfigGroup`）是用户与量化策略交互的起点，其核心功能是加载和验证策略文件。

### 策略文件选择与验证
该组件通过`select_strategy_file`方法实现策略文件的加载。用户点击“选择策略文件”按钮后，系统会弹出文件选择对话框，允许用户从文件系统中选择一个`.py`后缀的Python脚本文件。选择完成后，文件路径会显示在文本框中，并通过`validate_strategy_file`方法进行验证。

`validate_strategy_file`方法的验证逻辑包含三个关键步骤：
1.  **文件存在性检查**：确认用户选择的文件路径真实存在。
2.  **语法检查**：使用Python内置的`compile()`函数对策略文件的源代码进行编译，确保其语法正确，无语法错误。
3.  **必需函数检查**：动态导入策略模块，并检查其是否包含`init`和`khHandlebar`这两个必需的函数。如果缺少任一函数，将抛出异常并提示用户。

此验证机制确保了加载的策略文件是完整且可执行的，防止因策略文件不完整而导致回测过程失败。

**Section sources**
- [GUIkhQuant.py](file://GUIkhQuant.py#L1945-L1983)
- [modules/GUIkhQuant.md](file://modules/GUIkhQuant.md#L100-L123)

## 回测参数配置组
回测参数配置组（`BacktestConfigGroup`）负责定义回测的核心参数，包括基准合约、交易成本和回测时间范围。

### 交易成本设置
该组件允许用户精细化地配置交易成本，以模拟真实交易环境。主要配置项包括：
*   **最低佣金**：设置每笔交易的最低佣金，单位为元。
*   **佣金比例**：设置按成交金额计算的佣金比例。
*   **卖出印花税**：设置卖出股票时需缴纳的印花税率。
*   **流量费**：设置每笔交易的固定流量费用。

这些成本参数将直接影响回测结果的收益计算，使回测结果更具现实参考价值。

### 滑点设置
滑点是模拟交易中不可避免的因素，该组件提供了两种滑点设置模式：
*   **按最小变动价位**：用户输入“跳数”，系统会根据A股0.01元的最小变动价位，计算出实际滑点（例如，2跳即为0.02元）。
*   **按成交额比例**：用户输入一个百分比值，系统会根据成交金额计算出滑点。

这种灵活的设置方式允许用户根据不同的策略类型（如高频交易或低频交易）来调整滑点模型。

### 回测时间设置
用户可以通过日期选择器设定回测的开始日期和结束日期。系统会根据此时间范围，从本地数据中加载相应的历史行情数据进行回测。

**Section sources**
- [GUIkhQuant.py](file://GUIkhQuant.py#L1367-L1455)
- [modules/GUIkhQuant.md](file://modules/GUIkhQuant.md#L125-L149)

## 数据设置组
数据设置组（`DataConfigGroup`）负责配置回测所使用的行情数据类型和字段。

### 复权方式
复权方式决定了历史K线数据的处理方式，以消除分红、配股等事件对股价的影响。可选项包括：
*   **不复权**：不进行任何处理，股价保持原始状态。
*   **前复权**：将历史价格调整到以当前价格为基准。
*   **后复权**：将历史价格调整到以历史价格为基准。
*   **等比前/后复权**：采用等比方式计算复权因子，更精确地反映长期收益率。

### 周期类型
用户可以选择回测所使用的数据周期，包括`tick`（分笔数据）、`1m`（1分钟）、`5m`（5分钟）和`1d`（日K线）。不同的周期类型适用于不同频率的交易策略。

### 动态字段生成
该组件的核心功能是`update_data_fields`方法。当用户在“周期类型”下拉框中选择不同的周期时，该方法会动态更新可选的数据字段列表。

其工作原理如下：
1.  **清空现有字段**：首先移除所有已存在的字段复选框。
2.  **根据周期选择字段集**：程序内部维护了两个字典`tick_fields`和`kline_fields`，分别存储了分笔数据和K线数据的可用字段。
3.  **动态生成复选框**：根据用户选择的周期，从对应的字典中获取字段列表，并为每个字段创建一个复选框，添加到界面布局中。

这种动态生成机制确保了用户只能选择与当前数据周期相匹配的字段，避免了无效配置。

**Section sources**
- [GUIkhQuant.py](file://GUIkhQuant.py#L3018-L3043)
- [modules/GUIkhQuant.md](file://modules/GUIkhQuant.md#L152-L185)

## 股票池管理组
股票池管理组（`StockPoolGroup`）负责定义策略交易的股票范围。

### 股票池构建
用户可以通过多种方式构建股票池：
*   **常用指数成分股**：提供上证50、沪深300、中证500等主流指数的快速选择，勾选后会自动加载该指数的所有成分股。
*   **自选清单**：用户可以点击“自选清单”链接，打开一个独立的编辑器来管理自己的股票列表。
*   **手动管理**：通过一个表格，用户可以手动添加、删除或清空股票代码。

### 股票池更新机制
当用户完成股票池的配置后，系统会通过`update_stock_list`方法将最终的股票代码列表更新到配置中。该方法会：
1.  遍历所有选中的指数池和自定义股票，收集所有不重复的股票代码。
2.  将股票代码列表直接存储在配置字典的`data.stock_list`字段中。
3.  移除旧的`stock_list_file`字段，以保持配置的简洁性。

**Section sources**
- [GUIkhQuant.py](file://GUIkhQuant.py#L1529-L1635)
- [khConfig.py](file://khConfig.py#L57-L79)
- [modules/GUIkhQuant.md](file://modules/GUIkhQuant.md#L187-L222)

## 配置文件结构
左侧配置面板的所有用户输入最终都会被序列化为一个JSON格式的`.kh`配置文件。`save_configuration`方法负责此过程，它将各个配置组的值整合成一个结构化的字典，然后写入文件。

一个典型的`.kh`配置文件结构如下：
```json
{
  "strategy": {
    "file_path": "strategies/双均线多股票_使用khMA函数.py",
    "run_mode": "backtest"
  },
  "backtest": {
    "benchmark": "sh.000300",
    "start_date": "2023-01-01",
    "end_date": "2023-12-31",
    "trade_cost": {
      "min_commission": 5.0,
      "commission_rate": 0.0001,
      "stamp_tax": 0.0005,
      "flow_fee": 0.0
    },
    "slippage": {
      "type": 0,
      "value": 0.001
    }
  },
  "data": {
    "fq_type": "front",
    "cycle_type": "1m",
    "fields": ["open", "high", "low", "close", "volume"]
  },
  "stock_pool": {
    "indices": ["sh.000300"],
    "custom_list_enabled": false,
    "manual_stocks": []
  }
}
```
此结构化的配置文件可以被`khFrame.py`中的`KhQuantFramework`类读取和解析，从而初始化回测环境。

**Section sources**
- [GUIkhQuant.py](file://GUIkhQuant.py#L2000-L2116)
- [modules/GUIkhQuant.md](file://modules/GUIkhQuant.md#L570-L632)

## 结论
左侧配置面板通过`StrategyConfigGroup`、`BacktestConfigGroup`、`DataConfigGroup`和`StockPoolGroup`四个功能组，为用户提供了一个全面且易用的量化回测配置环境。其核心价值在于将复杂的量化参数抽象为直观的图形控件，并通过严谨的验证和动态生成机制，确保配置的准确性和有效性。最终，所有配置被持久化为`.kh`文件，实现了配置的可复用和可分享，极大地提升了量化研究的效率。